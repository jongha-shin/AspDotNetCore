@{
    ViewData["Title"] = "인사평가";
    int a = 0;
    int b = 0;
}
<style>
    .nav-tabs .nav-link.active {
        font-weight: bold;
        color: #214085
    }

    .nav-tabs .nav-link {
        color: grey;
    }
</style>
@model List<인사평가>
<div class="text-center col-12 col-sm-8 offset-sm-2 p-2" style="background-color:white">
    <input id="HRsubmit" type="hidden" value="@ViewBag.HRsubmit"/>
    <ul class="nav nav-tabs mb-3" id="pills-tab" role="tablist">
        <li class="nav-item">
            <a class="nav-link" id="pills-home-tab" data-toggle="pill" href="#pills-home" role="tab" aria-controls="pills-home" aria-selected="true" onclick="showSelectY('N')">평가요청</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="pills-profile-tab" data-toggle="pill" href="#pills-profile" role="tab" aria-controls="pills-profile" aria-selected="false" onclick="showSelectY('Y')">평가완료내역</a>
        </li>
        <ul class="nav justify-content-end" id="SelectY" style="font-size:small; position:absolute; right:0px; top: 11px; display:none;">
            <a href="#" id="prevBtn" onclick="changeYear('-')"><img src="~/img/search-prev.png" style="width:13px; height:20px; margin:5px" /></a>
            <span style="margin:5px">@ViewBag.선택년 년</span>
            <a href="#" id="nextBtn" onclick="changeYear('+')"><img src="~/img/search-next.png" style="width:13px; height:20px; margin:5px" /></a>
        </ul>
    </ul>
    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">
            <div class="table-responsive">
                <table class="table-sm table-bordered" style="width:100%">
                    <thead>
                        <tr style="background-color: #3763ab; color:white">
                            <th>피평가자</th>
                            <th width="55%">평가지</th>
                            <th>평가</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            if (item.마감.Equals("N") || item.마감.Equals("T"))
                            {
                                a++;
                                <tr>
                                    <td class="AssessName">@item.피평가자</td>
                                    <td class="second_td">
                                        <span class="BigSubject" style="font-weight:bold">@item.평가지</span> <br />
                                        @*&lt <span class="Gubun">@item.구분</span> &gt*@
                                        <input class="StaffID" type="hidden" value="@item.피평가자ID" />
                                    </td>
                                    @if (item.마감.Equals("T"))   // 미제출 평가
                                    {
                                        <td class="third_td">
                                            <button class="btn btn-sm btn-outline-primary startHR" value="start">수정하기</button>
                                            <button class="btn btn-sm btn-primary submitHR">제출하기</button>
                                        </td>
                                    }
                                    @if (item.마감.Equals("N"))   // 새 평가
                                    {
                                        <td class="third_td"><button class="btn btn-sm btn-outline-primary startHR" value="start">평가시작</button></td>
                                    }
                                </tr>
                            }
                        }
                        @if (a == 0)
                        {
                            <tr>
                                <td colspan="3">데이터가 없습니다</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
            <div class="table-responsive">
                <table class="table-sm table-bordered" style="width:100%">
                    <thead>
                        <tr style="background-color: #3763ab; color:white">
                            <th>피평가자</th>
                            <th width="55%">평가지</th>
                            <th>평가</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model == null)
                        {
                            <tr>
                                <td colspan="3">데이터가 없습니다</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var item in Model)
                            {
                                @if (item.마감.Equals("Y"))
                                {
                                    b++;
                                    <tr>
                                        <td class="AssessNameY">@item.피평가자</td>
                                        <td class="second_tdY">
                                            @item.평가지
                                            <input class="StaffID" type="hidden" value="@item.피평가자ID" />
                                        </td>
                                        <td class="thrid_tdY"><button class="btn btn-sm btn-primary showHR" value="show">평가완료</button></td>
                                    </tr>
                                }
                            }
                        }
                        @if (b == 0)
                        {
                            <tr>
                                <td colspan="3">데이터가 없습니다</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
    var HRsubmit = $("#HRsubmit").val();
    if (HRsubmit == 'HRsubmit') {
        $("#pills-profile-tab").tab('show');
        $("#SelectY").show();
    } else {
        $("#pills-home-tab").tab('show');
    }
    $(document).ready(function (e) {
        genRowspan("AssessName");
        genRowspan("second_td");
        genRowspan("third_td");
        genRowspan("AssessNameY");

        $(".startHR").click(function () {
            let flag = $(this).val();
            let BigSubject = $(this).parent().parent().find("td.second_td").find("span.BigSubject").text();
            //let Gubun = $(this).parent().parent().find("td.second_td").find("span.Gubun").text();
            let AssesseeID = $(this).parent().parent().find("td.second_td").find("input.StaffID").val();

            if (BigSubject.indexOf('/') != -1) {
                BigSubject = BigSubject.replace(/\//gi, '-');
            }

            location.href = "/Approve/Sub32_1/" + flag + "/" + BigSubject + /*"/" + Gubun +*/ "/" + AssesseeID;
        });

        $(".showHR").click(function () {
            let flag = $(this).val();
            let BigSubject = $(this).parent().parent().find("td.second_tdY").text().trim();
            let AssesseeID = $(this).parent().parent().find("td.second_tdY").find("input.StaffID").val();
            //alert(flag + "/" + BigSubject + "/" + AssesseeID);
            if (BigSubject.indexOf('/') != -1) {
                BigSubject = BigSubject.replace(/\//gi, '-');
            }
            location.href = "/Approve/Sub32_1/" + flag + "/" + BigSubject + "/" + AssesseeID;

        });

        $(".submitHR").click(function () {
            let BigSubject = $(this).parent().parent().find("td.second_td").find("span.BigSubject").text();
            let AssesseeID = $(this).parent().parent().find("td.second_td").find("input.StaffID").val();
            if (BigSubject.indexOf('/') != -1) {
                BigSubject = BigSubject.replace(/\//gi, '-');
            }

            $.ajax({
                url: '/Approve/Sub32_4/' + AssesseeID + "/" + BigSubject,
                type: 'GET',
                contentType: "application/x-www-form-urlencoded;charset=utf-8",
                charset: "utf-8",
                success: function (result) {
                    if (result == "success") {
                        submitHR(AssesseeID, BigSubject);
                    } else {
                        alert("누락된 답변이 있습니다");
                    }
                },
                error: function () {
                    alert("err");
                },
            });
        });
    });

    function showSelectY(sign) {
        if (sign == 'Y') $("#SelectY").show();
        else $("#SelectY").hide();
    }

    function submitHR(AssesseeID, BigSubject) {
        $.ajax({
            url: '/Approve/Sub32_3/' + AssesseeID + "/" + BigSubject,
            type: 'GET',
            contentType: "application/x-www-form-urlencoded;charset=utf-8",
            charset: "utf-8",
            success: function (result) {
                if (result == "success") {
                    alert("제출완료");
                    location.href = "/Approve/Sub32";
                }
            },
            error: function () {
                alert("err");
            },
        });
    }

    function genRowspan(className) {
        $("." + className).each(function () {
            let rows = $("." + className + ":contains('" + $(this).text() + "')");
            if (rows.length > 1) {
                rows.eq(0).attr("rowspan", rows.length);
                rows.not(":eq(0)").remove();
            }
        });
    }

    function changeYear(sign) {
        let yearList = [];
        let today = new Date()
        let year = today.getFullYear;

        @if(Model == null)
        {
            @:yearList.push(year)
        }
        else
        {
            @foreach (var item in ViewBag.Years)
            {
                @:yearList.push('@item.년');
            }
        }
        let current_num = yearList.indexOf('@ViewBag.선택년');
        //alert("현재index: " + current_num + " / 배열길이: " + yearList.length)
        if (sign == '+') { // 배열 index 감소
            if (current_num - 1 < 0) {
                alert("데이터가 없습니다.")
            }
            else {
                location.href = "/Approve/Sub32/HRsubmit/" + yearList[current_num - 1];
            }
        } else {    // '-' 배열 index 증가
            if (current_num + 1 > yearList.length -1) {
                alert("데이터가 없습니다.")
            }
            else {
                //alert(monthList[current_num + 1])
                location.href = "/Approve/Sub32/HRsubmit/" + yearList[current_num + 1];
            }
        }
    }
</script>





